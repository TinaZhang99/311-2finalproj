---
title: "Final Project Analysis"
author: "Tina Zhang"
date: "2019/5/24"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
packages <- c("dplyr","glmnet","ggplot2","broom","knitr")
load.packages <- function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
}
lapply(packages, load.packages)
```

#Load Data
The following block of code was auto-generated by and downloaded from the National Center for Educational Statistics
```{r loaddata}
# Load R Data File
load("els_02_12_byf3pststu_v1_0.rdata")

# Vector of selected variables
keepvars <- c(
   "bysex",
   "byrace",
   "bystlang",
   "BYSTLNG2",
   "byplang",
   "byfcomp",
   "bysibhom",
   "bymothed",
   "byfathed",
   "byincome",
   "bynonusg",
   "byparasp",
   "byschprg",
   "byfrrace",
   "byfrgrim",
   "byhispor",
   "bynsport",
   "byxtracu",
   "BYG10EP",
   "byscenp",
   "bysctrl",
   "byurban",
   "byregion",
   "BY10FLP",
   "F1TVVIGM",
   "F1COMPHR",
   "F2EVERDO",
   "F2HSATTM",
   "F2EVRATT",
   "F3EVRATT",
   "F3PS1SEC",
   "F3PSSELECT",
   "F3ATTAINMENT",
   "F3EMPSTAT",
   "F3ONET2CURR",
   "F3ERN2011",
   "F3MARRSTATUS",
   "F3SINGLEPAR",
   "F3TZGPAALL",
   "F3TZGPA1STSC",
   "F3TZNSTM1GPA",
   "F3TZSTEM1GPA",
   "BYS20A",
   "BYS20C",
   "BYS20E",
   "BYS20F",
   "BYS20J",
   "BYS21D",
   "BYS27A",
   "BYS27B",
   "BYS27D",
   "BYS28",
   "BYS33G",
   "BYS33H",
   "BYS33I",
   "BYS33L",
   "BYS34B",
   "BYS37",
   "BYS42",
   "BYS44B",
   "BYS44C",
   "BYS54C",
   "BYS54L",
   "BYS54O",
   "BYS85B",
   "BYS85C",
   "BYS85D",
   "BYS86A",
   "BYS86B",
   "BYS87B",
   "BYS87C",
   "BYS87D",
   "BYS89J",
   "F3A14A",
   "F3B01",
   "BYP10",
   "BYP49",
   "BYP57K",
   "BYP68")

# Create new object containing only selected variables
data <- els_02_12_byf3pststu_v1_0[ ,keepvars]
```

#Data Cleaning
```{r data_cleaning}
#Drop empty/invalid responses
data[data < 0] <- NA
replace <- which(colnames(data) %in% c("byhispor","bynsport","F1TVVIGM","F1COMPHR"))
data[,replace][data[,replace]==99] <- NA


#Check which variables have too many missing values
na_count <-sapply(data, function(y) sum(length(which(is.na(y)))))
many_na <- na_count[na_count > 8000]

#Remove NAs to apply LASSO
NoNA <- na.omit(data)

#Create binary variables from categorical variables
NoNA <- NoNA %>% mutate(
  female = bysex -1,
  bysex = NULL,
  nativeam = ifelse(byrace==1, 1, 0),
  asian = ifelse(byrace==2, 1, 0),
  black = ifelse(byrace==3, 1, 0),
  hispanic = ifelse((byrace==4|byrace==5), 1, 0),
  mixed = ifelse(byrace==6, 1, 0),
  byrace = NULL,
  northeast = ifelse(byregion==1,1,0),
  south = ifelse(byregion==3,1,0),
  west = ifelse(byregion==4,1,0),
  byregion = NULL,
  prepschool = ifelse(byschprg==2,1,0),
  vocaschool = ifelse(byschprg==3,1,0),
  byschprg = NULL,
  cathoschool = ifelse(bysctrl==2,1,0),
  otherprivate = ifelse(bysctrl==3,1,0),
  bysctrl=NULL,
  management = ifelse(F3ONET2CURR==11,1,0),
  busi_fin = ifelse(F3ONET2CURR==13,1,0),
  compmath = ifelse(F3ONET2CURR==15,1,0),
  archengi = ifelse(F3ONET2CURR==17,1,0),
  lifesocsci = ifelse(F3ONET2CURR==19,1,0),
  comserv = ifelse(F3ONET2CURR==21,1,0),
  legal = ifelse(F3ONET2CURR==23,1,0),
  edu = ifelse(F3ONET2CURR==25,1,0),
  artmedia = ifelse(F3ONET2CURR==27,1,0),
  healthcare_prac = ifelse(F3ONET2CURR==29,1,0),
  healthcare_supp = ifelse(F3ONET2CURR==31,1,0),
  protect = ifelse(F3ONET2CURR==33,1,0),
  foodprep = ifelse(F3ONET2CURR==35,1,0),
  buildmaint = ifelse(F3ONET2CURR==37,1,0),
  personalcare = ifelse(F3ONET2CURR==39,1,0),
  sales = ifelse(F3ONET2CURR==41,1,0),
  farmfish = ifelse(F3ONET2CURR==43,1,0),
  construction = ifelse(F3ONET2CURR==47,1,0),
  install_repair = ifelse(F3ONET2CURR==49,1,0),
  production = ifelse(F3ONET2CURR==51,1,0),
  transport = ifelse(F3ONET2CURR==53,1,0),
  military = ifelse(F3ONET2CURR==55,1,0),
  F3ONET2CURR = NULL,
  married = ifelse(F3MARRSTATUS==1,1,0),
  divor_sep = ifelse(F3MARRSTATUS %in% 4:7,1,0),
  F3MARRSTATUS = NULL,
  ps2year = ifelse(F3PS1SEC %in% 4:9, 1,0),
  psprivnfp = ifelse(F3PS1SEC %in% c(2,5,8), 1,0),
  psprivfp = ifelse(F3PS1SEC %in% c(3,6,9), 1,0),
  F3PS1SEC = NULL)

#Save the list of all regressors
write.csv(colnames(NoNA),"All Variables.csv")
```

#Perform LASSO
```{r LASSO}
x <- as.matrix(subset(NoNA, select = -c(F3ERN2011)))
y <- NoNA$F3ERN2011

#Identify optimal lambda
lambda <- 10^seq(-2,4,by=0.2)
set.seed(20)
train <- sample(1:nrow(NoNA),nrow(NoNA)/2)
lcv <- cv.glmnet(x[train, ], y[train], nfold = 3, alpha = 1, lambda = lambda)
lbestlam <- lcv$lambda.min
print(lbestlam)

#Apply LASSO with optimal lambda to identify significant regressors
bestlasso <- glmnet(x , y, alpha = 1, lambda = lbestlam)
lc <- broom::tidy(bestlasso)
sig <- lc[abs(lc$estimate)>=100,]
write.csv(lc, "lasso_outputs.csv")
kable(sig,digits = 3)

#Graph how coefficients change for different lambda Values
graphlasso <- glmnet(x , y, alpha = 1, lambda = lambda)
lcoeff <- tidy(graphlasso)
lnointercept <- subset(lcoeff, term!="(Intercept)")
plot <- ggplot(lnointercept) +
  geom_line(aes(lambda, estimate, color = term)) +
  labs(x = "Lambda", y = "Estimated Coefficient", 
       title = "Coefficient Estimates of Earnings Predictors vs. Lambda", 
       color = "Regressors") + theme(legend.position = "bottom", 
                                     legend.text = element_text(size = 5),
                                     legend.title = element_blank(),
                                     plot.margin = unit(c(1,1,0,1), "cm")) +
  guides(color=guide_legend(nrow=11, byrow=TRUE))
ggsave(filename = "LambdaGraph.jpg", plot = plot, height = 7, width = 8)

#Compute test set MSE
lasso.mod <- glmnet(x[train, ], y[train], alpha = 1,lambda = lambda)
lasso.pred= predict(lasso.mod,s=lbestlam, newx=x[-train,])
MSE <- mean((lasso.pred-y[-train])^2)
print(MSE)
```

#Examine correlation between GPA and Personal Beliefs variables
```{r correlation}
perbeliefs <- NoNA[,c("BYS27A","BYS27B","BYS27D","BYS28","BYS37","BYS54C",
                      "BYS54L","BYS54O","BYS87B","BYS87C","BYS89J")]
corgrades <- cor(perbeliefs, NoNA$F3TZGPAALL)
kable(corgrades,digits = 3)
```